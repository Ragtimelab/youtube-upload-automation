{% extends "base.html" %}

{% block title %}{{ title }} - 상태 모니터링{% endblock %}

{% block content %}
<div class="row">
    <!-- 시스템 상태 -->
    <div class="col-md-6 mb-4">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-server me-2"></i>시스템 상태
                </h5>
            </div>
            <div class="card-body">
                <div id="system-status">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>API 서버</span>
                        <span class="badge bg-success" id="api-status">정상</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>데이터베이스</span>
                        <span class="badge bg-success" id="db-status">연결됨</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>업로드 시스템</span>
                        <span class="badge bg-warning" id="upload-status">확인 중</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>YouTube API</span>
                        <span class="badge bg-warning" id="youtube-status">확인 중</span>
                    </div>
                    
                    <hr>
                    
                    <div class="text-center">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshSystemStatus()">
                            <i class="fas fa-sync-alt me-1"></i>상태 새로고침
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 파이프라인 상태 -->
    <div class="col-md-6 mb-4">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>파이프라인 진행률
                </h5>
            </div>
            <div class="card-body">
                <div id="pipeline-progress">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>전체 진행률</span>
                            <span id="total-progress-text">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-info" id="total-progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-3">
                            <h6 class="text-warning" id="script-ready-count">{{ stats.script_ready or 0 }}</h6>
                            <small class="text-muted">스크립트<br>준비</small>
                        </div>
                        <div class="col-3">
                            <h6 class="text-info" id="video-ready-count">{{ stats.video_ready or 0 }}</h6>
                            <small class="text-muted">비디오<br>준비</small>
                        </div>
                        <div class="col-3">
                            <h6 class="text-primary" id="uploading-count">{{ stats.uploading or 0 }}</h6>
                            <small class="text-muted">업로드<br>진행</small>
                        </div>
                        <div class="col-3">
                            <h6 class="text-success" id="uploaded-count">{{ stats.uploaded or 0 }}</h6>
                            <small class="text-muted">업로드<br>완료</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 상세 통계 -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>상태별 스크립트 현황
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="refreshStats()">
                    <i class="fas fa-sync-alt me-1"></i>새로고침
                </button>
            </div>
            <div class="card-body">
                <div id="status-breakdown">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>상태</th>
                                    <th width="100" class="text-center">개수</th>
                                    <th width="200">진행률</th>
                                    <th>권장 액션</th>
                                </tr>
                            </thead>
                            <tbody id="status-table-body">
                                <!-- 동적으로 업데이트 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 최근 활동 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>최근 활동
                </h6>
            </div>
            <div class="card-body">
                <div id="recent-activity" style="max-height: 300px; overflow-y: auto;">
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot success me-2"></div>
                        <small class="text-muted">시스템 정상 가동 중</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot success me-2"></div>
                        <small class="text-muted">데이터베이스 연결됨</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot warning me-2"></div>
                        <small class="text-muted">YouTube API 상태 확인 중</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 퀵 액션 -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>퀵 액션
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" onclick="openScripts()">
                        <i class="fas fa-plus me-1"></i>스크립트 업로드
                    </button>
                    <button class="btn btn-info btn-sm" onclick="openVideos()">
                        <i class="fas fa-video me-1"></i>비디오 관리
                    </button>
                    <button class="btn btn-success btn-sm" onclick="openYouTube()">
                        <i class="fab fa-youtube me-1"></i>YouTube 관리
                    </button>
                    <hr>
                    <button class="btn btn-outline-secondary btn-sm" onclick="downloadLogs()">
                        <i class="fas fa-download me-1"></i>로그 다운로드
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 실시간 모니터링 -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-heartbeat me-2"></i>실시간 모니터링
                </h6>
                <small id="last-updated">마지막 업데이트: {{ current_time if current_time else '로드 중...' }}</small>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-2">
                        <h5 class="text-primary mb-0" id="total-scripts">{{ stats.total or 0 }}</h5>
                        <small class="text-muted">전체 스크립트</small>
                    </div>
                    <div class="col-md-2">
                        <h5 class="text-warning mb-0" id="pending-uploads">{{ stats.script_ready or 0 }}</h5>
                        <small class="text-muted">업로드 대기</small>
                    </div>
                    <div class="col-md-2">
                        <h5 class="text-info mb-0" id="ready-youtube">{{ stats.video_ready or 0 }}</h5>
                        <small class="text-muted">YouTube 대기</small>
                    </div>
                    <div class="col-md-2">
                        <h5 class="text-primary mb-0" id="active-uploads">{{ stats.uploading or 0 }}</h5>
                        <small class="text-muted">업로드 중</small>
                    </div>
                    <div class="col-md-2">
                        <h5 class="text-success mb-0" id="completed-uploads">{{ stats.uploaded or 0 }}</h5>
                        <small class="text-muted">완료</small>
                    </div>
                    <div class="col-md-2">
                        <h5 class="text-danger mb-0" id="error-count">{{ stats.error or 0 }}</h5>
                        <small class="text-muted">오류</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    refreshSystemStatus();
    refreshStats();
    
    // 자동 새로고침 (30초마다)
    setInterval(() => {
        refreshSystemStatus();
        refreshStats();
    }, 30000);
});

// 시스템 상태 새로고침
async function refreshSystemStatus() {
    try {
        // API 서버 상태
        const healthResponse = await Utils.apiCall('/health');
        if (healthResponse.success) {
            const services = healthResponse.services;
            
            updateStatusBadge('api-status', services.api === 'operational' ? '정상' : '오류', 
                             services.api === 'operational' ? 'success' : 'danger');
            updateStatusBadge('db-status', services.database === 'connected' ? '연결됨' : '오류', 
                             services.database === 'connected' ? 'success' : 'danger');
        }
        
        // 업로드 시스템 상태
        const uploadResponse = await Utils.apiCall('/upload/health');
        if (uploadResponse.success) {
            const uploadServices = uploadResponse.services;
            
            updateStatusBadge('upload-status', uploadServices.upload_system === 'operational' ? '정상' : '오류',
                             uploadServices.upload_system === 'operational' ? 'success' : 'danger');
            updateStatusBadge('youtube-status', uploadServices.youtube_api === 'connected' ? '연결됨' : '오류',
                             uploadServices.youtube_api === 'connected' ? 'success' : 'danger');
        }
        
    } catch (error) {
        console.error('시스템 상태 새로고침 실패:', error);
        updateStatusBadge('api-status', '오류', 'danger');
        updateStatusBadge('db-status', '오류', 'danger');
        updateStatusBadge('upload-status', '오류', 'danger');
        updateStatusBadge('youtube-status', '오류', 'danger');
    }
    
    // 마지막 업데이트 시간
    document.getElementById('last-updated').textContent = `마지막 업데이트: ${new Date().toLocaleTimeString('ko-KR')}`;
}

// 상태 배지 업데이트
function updateStatusBadge(elementId, text, type) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = text;
        element.className = `badge bg-${type}`;
    }
}

// 통계 새로고침
async function refreshStats() {
    try {
        const response = await Utils.apiCall('/scripts/stats');
        if (response.success) {
            const stats = response.data;
            
            // 기본 통계 업데이트
            document.getElementById('script-ready-count').textContent = stats.script_ready || 0;
            document.getElementById('video-ready-count').textContent = stats.video_ready || 0;
            document.getElementById('uploading-count').textContent = stats.uploading || 0;
            document.getElementById('uploaded-count').textContent = stats.uploaded || 0;
            
            // 실시간 모니터링 업데이트
            document.getElementById('total-scripts').textContent = stats.total || 0;
            document.getElementById('pending-uploads').textContent = stats.script_ready || 0;
            document.getElementById('ready-youtube').textContent = stats.video_ready || 0;
            document.getElementById('active-uploads').textContent = stats.uploading || 0;
            document.getElementById('completed-uploads').textContent = stats.uploaded || 0;
            document.getElementById('error-count').textContent = stats.error || 0;
            
            // 진행률 계산 및 업데이트
            const total = stats.total || 1;
            const completed = stats.uploaded || 0;
            const progress = Math.round((completed / total) * 100);
            
            document.getElementById('total-progress-text').textContent = `${progress}%`;
            document.getElementById('total-progress-bar').style.width = `${progress}%`;
            
            // 상세 테이블 업데이트
            updateStatusTable(stats);
        }
    } catch (error) {
        console.error('통계 새로고침 실패:', error);
    }
}

// 상태별 테이블 업데이트
function updateStatusTable(stats) {
    const tableBody = document.getElementById('status-table-body');
    
    const statusConfig = [
        { key: 'script_ready', name: '스크립트 준비', color: 'warning', action: '비디오 업로드 필요' },
        { key: 'video_ready', name: '비디오 준비', color: 'info', action: 'YouTube 업로드 필요' },
        { key: 'uploading', name: '업로드 중', color: 'primary', action: '진행 중 - 대기' },
        { key: 'uploaded', name: '업로드 완료', color: 'success', action: '완료' },
        { key: 'error', name: '오류', color: 'danger', action: '오류 해결 필요' },
        { key: 'scheduled', name: '예약됨', color: 'secondary', action: '예약 대기 중' }
    ];
    
    const total = stats.total || 1;
    
    tableBody.innerHTML = statusConfig.map(config => {
        const count = stats[config.key] || 0;
        const percentage = Math.round((count / total) * 100);
        
        return `
            <tr>
                <td>
                    <span class="badge bg-${config.color}">${config.name}</span>
                </td>
                <td class="text-center">
                    <strong>${count}</strong>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-${config.color}" 
                             role="progressbar" style="width: ${percentage}%">
                            ${percentage}%
                        </div>
                    </div>
                </td>
                <td>
                    <small class="text-muted">${config.action}</small>
                </td>
            </tr>
        `;
    }).join('');
}

// 퀵 액션 함수들
function openScripts() {
    window.open('/scripts', '_blank');
}

function openVideos() {
    window.open('/videos', '_blank');
}

function openYouTube() {
    window.open('/youtube', '_blank');
}

function downloadLogs() {
    Utils.showAlert('로그 다운로드 기능은 곧 구현될 예정입니다.', 'info');
}
</script>
{% endblock %}