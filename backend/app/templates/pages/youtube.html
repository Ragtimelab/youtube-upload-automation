{% extends "base.html" %}

{% block title %}{{ title }} - YouTube 관리{% endblock %}

{% block content %}
<div class="row">
    <!-- YouTube 할당량 정보 -->
    <div class="col-md-4 mb-4">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fab fa-youtube me-2"></i>YouTube API 할당량
                </h6>
            </div>
            <div class="card-body">
                <div id="quota-info">
                    <div class="text-center mb-3">
                        <h4 class="text-primary" id="quota-used">-</h4>
                        <small class="text-muted">사용량 / 10,000 units</small>
                    </div>
                    
                    <div class="progress mb-3">
                        <div class="progress-bar bg-primary" id="quota-progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <strong id="remaining-uploads">-</strong>
                            <div class="small text-muted">잔여 업로드</div>
                        </div>
                        <div class="col-6">
                            <strong id="reset-time">PT 자정</strong>
                            <div class="small text-muted">리셋 시간</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 배치 업로드 설정 -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">⚡ 배치 업로드 설정</h6>
            </div>
            <div class="card-body">
                <form id="batch-settings-form">
                    <div class="mb-3">
                        <label for="batch-privacy" class="form-label">공개 설정</label>
                        <select class="form-select form-select-sm" id="batch-privacy">
                            <option value="private" selected>비공개</option>
                            <option value="unlisted">링크 공유</option>
                            <option value="public">공개</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="batch-delay" class="form-label">업로드 간격 (초)</label>
                        <input type="number" class="form-control form-control-sm" 
                               id="batch-delay" value="60" min="30" max="300">
                        <small class="text-muted">API 제한을 위한 간격</small>
                    </div>
                    <button type="button" class="btn btn-success btn-sm w-100" onclick="startBatchUpload()">
                        <i class="fas fa-rocket me-1"></i>배치 업로드 시작
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 업로드된 비디오 목록 -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fab fa-youtube me-2"></i>업로드된 YouTube 비디오 ({{ uploaded_scripts|length }}개)
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="loadUploadedVideos()">
                    <i class="fas fa-sync-alt me-1"></i>새로고침
                </button>
            </div>
            <div class="card-body p-0">
                {% if uploaded_scripts %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="60">ID</th>
                                    <th>제목</th>
                                    <th width="120">YouTube ID</th>
                                    <th width="100">조회수</th>
                                    <th width="120">업로드일</th>
                                    <th width="150">링크</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for script in uploaded_scripts %}
                                <tr>
                                    <td class="fw-bold">#{{ script.id }}</td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 200px;" title="{{ script.title }}">
                                            {{ script.title }}
                                        </div>
                                    </td>
                                    <td>
                                        {% if script.youtube_video_id %}
                                            <small class="text-muted font-monospace">{{ script.youtube_video_id }}</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">-</small>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ script.updated_at[:10] if script.created_at else '-' }}
                                        </small>
                                    </td>
                                    <td>
                                        {% if script.youtube_video_id %}
                                            <a href="https://youtube.com/watch?v={{ script.youtube_video_id }}" 
                                               target="_blank" class="btn btn-outline-primary btn-sm">
                                                <i class="fab fa-youtube me-1"></i>보기
                                            </a>
                                        {% else %}
                                            <span class="text-muted">링크 없음</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state py-5">
                        <i class="fab fa-youtube"></i>
                        <h6>업로드된 YouTube 비디오가 없습니다</h6>
                        <p class="text-muted">비디오를 YouTube에 업로드해보세요!</p>
                        <a href="/videos" class="btn btn-outline-primary btn-sm">비디오 관리</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 실시간 업로드 현황 -->
<div class="row mt-4" id="upload-activity" style="display: none;">
    <div class="col-md-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="fas fa-cloud-upload-alt me-2"></i>실시간 업로드 현황
                </h6>
            </div>
            <div class="card-body">
                <div id="upload-progress-list">
                    <!-- 동적으로 업데이트 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// 페이지 로드 시 할당량 정보 로드
document.addEventListener('DOMContentLoaded', function() {
    loadQuotaInfo();
    
    // 30초마다 할당량 정보 업데이트
    setInterval(loadQuotaInfo, 30000);
});

// YouTube API 할당량 정보 로드
async function loadQuotaInfo() {
    try {
        const response = await Utils.apiCall('/upload/quota');
        if (response.success) {
            const quota = response.data;
            const used = quota.used || 0;
            const total = quota.total || 10000;
            const percentage = (used / total) * 100;
            const remaining = Math.floor((total - used) / 1600); // 1회 업로드당 1600 units
            
            document.getElementById('quota-used').textContent = `${used:,}`;
            document.getElementById('quota-progress').style.width = `${percentage}%`;
            document.getElementById('remaining-uploads').textContent = remaining;
            
            // 상태에 따른 색상 변경
            const progressBar = document.getElementById('quota-progress');
            if (percentage < 50) {
                progressBar.className = 'progress-bar bg-success';
            } else if (percentage < 80) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-danger';
            }
        }
    } catch (error) {
        console.error('할당량 정보 로드 실패:', error);
        document.getElementById('quota-used').textContent = '오류';
    }
}

// 배치 업로드 시작
async function startBatchUpload() {
    const privacy = document.getElementById('batch-privacy').value;
    const delay = parseInt(document.getElementById('batch-delay').value);
    
    // video_ready 상태의 모든 스크립트 ID 수집
    try {
        const response = await Utils.apiCall('/scripts?status=video_ready');
        if (response.success && response.data.length > 0) {
            const scriptIds = response.data.map(script => script.id);
            
            const confirmed = confirm(
                `${scriptIds.length}개의 비디오를 YouTube에 배치 업로드하시겠습니까?\n\n` +
                `예상 할당량 사용: ${scriptIds.length * 1600} units\n` +
                `예상 소요 시간: ${Math.ceil(scriptIds.length * delay / 60)}분`
            );
            
            if (confirmed) {
                await YouTubeManager.batchUploadToYouTube(scriptIds, {
                    privacy: privacy,
                    category: 22,
                    delay: delay
                });
                
                // 업로드 현황 섹션 표시
                document.getElementById('upload-activity').style.display = 'block';
                startUploadMonitoring(scriptIds);
            }
        } else {
            Utils.showAlert('배치 업로드할 비디오가 없습니다.', 'warning');
        }
    } catch (error) {
        console.error('배치 업로드 실패:', error);
        Utils.showAlert('배치 업로드 시작에 실패했습니다.', 'danger');
    }
}

// 업로드 모니터링 시작
function startUploadMonitoring(scriptIds) {
    const progressList = document.getElementById('upload-progress-list');
    
    // 초기 진행 상황 표시
    progressList.innerHTML = scriptIds.map(id => `
        <div id="progress-${id}" class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
            <span>스크립트 #${id}</span>
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span class="badge bg-primary">대기 중</span>
            </div>
        </div>
    `).join('');
    
    // 주기적으로 상태 확인
    const monitorInterval = setInterval(async () => {
        let allCompleted = true;
        
        for (const scriptId of scriptIds) {
            try {
                const response = await Utils.apiCall(`/scripts/${scriptId}`);
                if (response.success) {
                    const script = response.data;
                    const progressElement = document.getElementById(`progress-${scriptId}`);
                    
                    if (progressElement) {
                        const statusBadge = progressElement.querySelector('.badge');
                        const spinner = progressElement.querySelector('.spinner-border');
                        
                        if (script.status === 'uploaded') {
                            statusBadge.className = 'badge bg-success';
                            statusBadge.textContent = '완료';
                            spinner.style.display = 'none';
                        } else if (script.status === 'error') {
                            statusBadge.className = 'badge bg-danger';
                            statusBadge.textContent = '실패';
                            spinner.style.display = 'none';
                        } else if (script.status === 'uploading') {
                            statusBadge.className = 'badge bg-warning';
                            statusBadge.textContent = '업로드 중';
                            allCompleted = false;
                        } else {
                            allCompleted = false;
                        }
                    }
                }
            } catch (error) {
                console.error(`스크립트 ${scriptId} 상태 확인 실패:`, error);
                allCompleted = false;
            }
        }
        
        if (allCompleted) {
            clearInterval(monitorInterval);
            Utils.showAlert('배치 업로드가 완료되었습니다!', 'success');
            loadQuotaInfo(); // 할당량 정보 업데이트
            loadUploadedVideos(); // 목록 새로고침
        }
    }, 5000); // 5초마다 확인
    
    // 30분 후 모니터링 중단
    setTimeout(() => {
        clearInterval(monitorInterval);
    }, 30 * 60 * 1000);
}

// 업로드된 비디오 목록 새로고침
function loadUploadedVideos() {
    location.reload(); // 간단하게 페이지 새로고침
}
</script>
{% endblock %}